<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>blockyLuau — Blockly → Luau (Roblox)</title>

  <!-- Blockly CDN (si tu préfères, télécharge et sert localement) -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>blockyLuau — Blockly → Luau</h1>
    <div class="hint">Prototype : génère du Luau copiable vers Roblox Studio</div>
  </header>

  <main class="container">
    <section class="editor card">
      <div class="toolbar">
        <button id="btnGenerate">Générer le Luau</button>
        <button id="btnClear" class="ghost">Vider</button>
        <button id="btnSample" class="ghost">Charger exemple</button>
      </div>

      <div id="blocklyDiv"></div>

      <!-- Toolbox -->
      <xml id="toolbox" style="display:none">
        <category name="Contrôle" colour="#5C81A6">
          <block type="controls_repeat_ext"></block>
          <block type="controls_if"></block>
        </category>
        <category name="Math" colour="#5CA65C">
          <block type="math_number"></block>
          <block type="math_arithmetic"></block>
        </category>
        <category name="Texte" colour="#5C8FA6">
          <block type="text"></block>
          <block type="text_print"></block>
        </category>
        <category name="Roblox (Luau)" colour="#D46B00">
          <block type="roblox_print"></block>
          <block type="roblox_wait"></block>
          <block type="roblox_instance_new"></block>
          <block type="roblox_set_property"></block>
          <block type="roblox_find_service"></block>
          <block type="roblox_fire_event"></block>
        </category>
        <category name="Variables" colour="#A65C9E">
          <block type="variables_get"></block>
          <block type="variables_set"></block>
        </category>
      </xml>
    </section>

    <aside class="side">
      <div class="card controls">
        <button id="btnCopy">Copier dans le presse-papier</button>
        <button id="btnDownload" class="ghost">Télécharger .lua</button>
        <button id="btnFormat" class="ghost">Reformater (basique)</button>
      </div>

      <div class="card output">
        <label>Code Luau généré</label>
        <pre id="output">-- Appuie sur "Générer le Luau" pour voir le code ici.</pre>
      </div>

      <div class="card xmlio">
        <label>Importer / Exporter</label>
        <div class="xml-controls">
          <button id="btnExportXml" class="ghost">Exporter XML</button>
          <button id="btnImportXml" class="ghost">Importer XML</button>
        </div>
        <textarea id="xmlInput" placeholder="Coller XML ici puis Importer"></textarea>
      </div>
    </aside>
  </main>

  <!-- Tes blocs et générateur -->
  <script src="blocks.js"></script>
  <script src="generator_luau.js"></script>

  <script>
    // Inject le workspace (après que Blockly soit chargé)
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      scrollbars: true,
      trashcan: true,
      renderer: 'thrasos'
    });

    // Exemple XML
    const sampleXml = `
      <xml xmlns="https://developers.google.com/blockly/xml">
        <block type="roblox_print" x="20" y="20">
          <value name="TXT">
            <block type="text"><field name="TEXT">Hello from blockyLuau!</field></block>
          </value>
        </block>
      </xml>
    `;

    document.getElementById('btnGenerate').addEventListener('click', () => {
      const code = Blockly.Lua.workspaceToCode(workspace) || '-- (vide)';
      document.getElementById('output').innerText = code;
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      workspace.clear();
      document.getElementById('output').innerText = '-- Workspace vidé';
    });

    document.getElementById('btnSample').addEventListener('click', () => {
      workspace.clear();
      const dom = Blockly.Xml.textToDom(sampleXml);
      Blockly.Xml.domToWorkspace(dom, workspace);
    });

    document.getElementById('btnExportXml').addEventListener('click', () => {
      const xmlDom = Blockly.Xml.workspaceToDom(workspace);
      const xmlText = Blockly.Xml.domToPrettyText(xmlDom);
      document.getElementById('xmlInput').value = xmlText;
    });

    document.getElementById('btnImportXml').addEventListener('click', () => {
      const txt = document.getElementById('xmlInput').value;
      try {
        const dom = Blockly.Xml.textToDom(txt);
        workspace.clear();
        Blockly.Xml.domToWorkspace(dom, workspace);
        alert('Workspace importé !');
      } catch(e) {
        alert('XML invalide');
      }
    });

    document.getElementById('btnCopy').addEventListener('click', async () => {
      const code = Blockly.Lua.workspaceToCode(workspace) || '';
      try { await navigator.clipboard.writeText(code); alert('Code copié !'); }
      catch(e) { alert('Impossible de copier automatiquement.'); }
    });

    document.getElementById('btnDownload').addEventListener('click', () => {
      const code = Blockly.Lua.workspaceToCode(workspace) || '';
      const blob = new Blob([code], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'script.lua'; a.click(); URL.revokeObjectURL(url);
    });

    // Charger l'exemple au chargement
    window.addEventListener('load', () => {
      const dom = Blockly.Xml.textToDom(sampleXml);
      Blockly.Xml.domToWorkspace(dom, workspace);
    });
  </script>
</body>
</html>
